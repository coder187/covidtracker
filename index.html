<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 Tracker</title>

    <!-- note order of Lib includes is important-->
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

    <!--ARGCGIS Lib-->
    <link rel="stylesheet" href="https://js.arcgis.com/4.19/esri/themes/light/main.css">

    <!-- Font Aswesome-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css">
    <!--Hover JS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hover.css/2.1.1/css/hover-min.css" type="text/css" />

    <!-- CHART.JS Lib-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.js"></script>

    <!--custom-->
    <link rel="stylesheet" href="assets/css/style.css" />
    <script src="assets/js/main.js"></script>

</head>
<body>


    <!-- navbar code from https://getbootstrap.com/docs/4.0/components/navbar/ -->
    <!--<nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">  org -->
    <!--<nav class="navbar navbar-default sticky-top navbar-expand-lg navbar-light bg-light">  sticky works but not supported in all browsers -->
    <nav class="navbar navbar-default fixed-top navbar-expand-lg navbar-light bg-light">

        <a href="index.html" class="navbar-brand">COVID-19 Tracker</a>

        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                <!-- mr-atuo push left -->
                <li class="nav-item active "><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link nav-item" href="signup.html">Stay Up To Date</a></li>
                <li class="nav-item"><a class="nav-link" href="sources.html">Data Source Info</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Audio Toggle</a></li>
            </ul>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <!-- header data-->
            <div class="col-sm-3 top-lvl-stats">
                <!--date last updated-->
                <div class="label">Last Update:</div>
                <span id="date-last-updated"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col-sm-3 top-lvl-stats">
                <!--total cases to date-->
                <div class="label">Total Cases:</div>
                <span id="Total"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col-sm-3 top-lvl-stats">
                <!--new deaths reported-->
                <div class="label">Deaths Last Reported:</div>
                <span id="Deaths"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col-sm-3 top-lvl-stats">
                <!--new cases reported-->
                <div class="label">Cases Last Reported:</div>
                <span id="Cases"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
        </div>
        <covid19-cases-by-county>
            <div class="row">
                <div class="col-lg-3 cases-by-county table-responsive">
                    <!--total cases per county-->
                    <ul id="county-list"></ul>
                    <table id="county-list-table" class="">
                        <caption>Cases By County</caption>
                        <tr>
                            <th scope="col">County</th>
                            <th scope="col">Cases</th>
                            <th scope="col">Pop Perc</th>
                        </tr>
                        <tr>
                            <td colspan="3"><img src="assets/gif/loading.gif" alt="loading" /></td>
                        </tr>
                    </table>
                </div>

                <div class="col-lg-6">
                    <!-- MAIN MAP-->
                    <div class="row">
                        <div class="col">
                            <label for="maps">Choose a map:</label>
                            <select name="maps" id="select-maps">
                                <option value="LEA">14 Day Avg Per LEA</option>
                                <option value="saab">Cases Per County</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <!--lea 14 day moving avg MAP-->
                            <div id="mapview" style="height:500px;" class="esri-widget"></div> <!-- placing style in file breaks popup-->
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <!--MAP legend-->
                    <div id="legendview"></div>
                </div>
            </div><!-- end row-->
        </covid19-cases-by-county>
        <vaccination-data>
            <div class="row">
                <div class="col-md-4 vax-stats">
                    <div class="label">First Dose Vaccines:</div>
                    <span id="first-dose-total"><img src="assets/gif/loading.gif" alt="loading" /></span>
                </div>
                <div class="col-md-4 vax-stats">
                    <div class="label">Second Dose Vaccines:</div>
                    <span id="second-dose-total"><img src="assets/gif/loading.gif" alt="loading" /></span>
                </div>
                <div class="col-md-4 vax-stats">
                    <div class="label">Total Vaccines:</div>
                    <span id="vaccine-dose-total"><img src="assets/gif/loading.gif" alt="loading" /></span>
                </div>
            </div>
        </vaccination-data>

        <vaccintation-chart>
            <div class="row">
                <div class="col vaccination-chart-container">
                    <canvas id="myChart" width="400" height="400"></canvas>
                </div>
            </div>
        </vaccintation-chart>

        <footer>
            <div class="row">
                <div class="col-md-3"><h5 class="uppercase general-sub">arcgis.com</h5><a href="https://www.arcgis.com/index.html"><img src="assets/gif/arcgis-online-icon.png" alt="Arcgis Logo" /></a></div>
                <div class="col-md-3"><h5 class="uppercase general-sub">data.gov.ie</h5><a href="https://data.gov.ie/"><img src="assets/gif/dgi-logo-new_logo.png" alt="data.gov.ie logo" /></a></div>
                <div class="col-md-3"><h5 class="uppercase general-sub">ecdc.europa.eu</h5><a href="https://www.ecdc.europa.eu/en"><img src="assets/gif/logo-ecdc.png" alt="ECDC Logo" /></a></div>
                <div class="col-md-3">
                    <h5 class="uppercase general-sub">Website For Code Institute Course Work Only</h5>
                    <ul class="list-inline social-links">
                        <li class="list-inline-item">
                            <a href="https://www.facebook.com/" target="_blank">
                                <i class="fab fa-facebook-f" aria-hidden="true"></i>
                                <span class="sr-only">Facebook</span>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://www.twitter.com/" target="_blank">
                                <i class="fab fa-twitter" aria-hidden="true"></i>
                                <span class="sr-only">Twitter</span>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://www.github.com/coder187" target="_blank">
                                <i class="fab fa-github" aria-hidden="true"></i>
                                <span class="sr-only">Instagram</span>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://buslifeirl.tumblr.com/likes" target="_blank">
                                <i class="fab fa-tumblr" aria-hidden="true"></i>
                                <span class="sr-only">Tumblr</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </footer>
    </div> <!--end container-->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://js.arcgis.com/4.19/"></script> <!-- must load bootstrap js before arcgis -->
    <script>
        //Get Covid Stats:
        //Total Cases
        //New Cases
        //Deaths
        //Prev Day Cases
        //Prev Day Deaths

        GetCovidStats().then(
            function (message) {
                //console.log("Resolved: ", message);
                PrintCovidStats(message, 0);
            },
            function (error) {
                //console.log("Rejected: ", error);
                PrintCovidStats(message, 1);
            }
        );

        function PrintCovidStats(stats, err) {
            if (err !== 0) {
                document.getElementById("date-last-updated").innerHTML = "?";
                document.getElementById("Deaths").innerHTML = "?";
                document.getElementById("Cases").innerHTML = "?";
                document.getElementById("Total").innerHTML = "?";
            }
            else {
                document.getElementById("date-last-updated").innerHTML = stats.DateLastUpdated.toDateString();
                document.getElementById("Deaths").innerHTML = stats.Deaths;
                document.getElementById("Cases").innerHTML = stats.Cases;
                document.getElementById("Total").innerHTML = stats.TotalCases.toLocaleString();

                //might comw back to this - to add perc inc/ dec
                //console.log(stats.CasesPrevDay);
                //console.log(PrecDiff(stats.CasesPrevDay, stats.Cases));

                //console.log(stats.DeathsPrevDay);
                //console.log(PrecDiff(stats.DeathsPrevDay, stats.Deaths));



            }
        }
        function PrecDiff(org, newval) {

            let diff = newval - org;
            diff = (diff / org) * 100;

            return diff;
        }
    </script>
    <script>
        GetCountyStats().then(
            function (message) {
                //console.log("Resolved: ", message);
                PrintCountyStats(message, 0);
            },
            function (error) {
                //console.log("Print County Stats - Rejected: ", error);
                PrintCountyStats(message, 1);
            }
        );
        function PrintCountyStats(stats, err) {
            //let ul = document.getElementById("county-list");
            let tbl = document.getElementById("county-list-table");

            if (err !== 0) {
                //let li = document.createElement("li");
                //li.innerHTML = county[i] + "error ?";
                //ul.appendChild(li);

                let tr = document.createElement("tr");
                let td = document.createElement("td colspan=3");
                td.innerHTML = "error ?";
                tr.appendChild(td);
            }
            else {
                for (var i = 0; i < stats.length; i++) {

                    //let li = document.createElement("li");
                    //li.innerHTML = stats[i].County + "    " + stats[i].Confirmed + "    " + Math.round((stats[i].Confirmed / stats[i].PopulationC16) * 100 * 100)/100;//cases as percentage of County Population
                    //ul.appendChild(li);

                    let tr = document.createElement("tr");
                    let td = document.createElement("td");
                    td.innerHTML = stats[i].County;
                    tr.appendChild(td);

                    td = document.createElement("td");
                    td.innerHTML = stats[i].Confirmed;
                    td.classList.add("table-cell-align-right");
                    tr.appendChild(td);

                    td = document.createElement("td");
                    td.innerHTML = Math.round((stats[i].Confirmed / stats[i].PopulationC16) * 100 * 100) / 100 + "%";
                    td.classList.add("table-cell-align-right");
                    tr.appendChild(td);

                    tbl.appendChild(tr);
                }
            }
            tbl.deleteRow(1);//laoding gif
        }
    </script>

    <script>
        //GET VACCINE STATS
        //console.log("begin: vaccine stats");

        ////Uses XMLHTTPRrequest Which has been depreciated
        //GetVaccineStats().then(
        //    function (message) {
        //        //console.log("Resolved: ", message);
        //        PrintCovidVaccineStats(message, 0);
        //    },
        //    function (error) {
        //        //console.log("GetVAccineStats - Rejected: ", error);
        //        PrintCovidVaccineStats(message, 1);
        //    }
        //);
        ////console.log("end: vaccine stats");
        ///////////////////////////////////////////////////////////////////////////

        let vacccine_url = "https://opendata.ecdc.europa.eu/covid19/vaccine_tracker/json/"; //causes CORS error
        vacccine_url = "data/vaccine.json"; //local copy

        fetch(vacccine_url)
            .then(
                function (response) {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem loading vaccine file. Status Code: ' + response.status);
                        PrintCovidVaccineStats(response, 1)
                        return;
                    }

                    // Examine the text in the response
                    response.json().then(function (data) {
                        //console.log(data);
                        PrintCovidVaccineStats(ExtractROIVaccineData(data), 0);
                    });
                }
            )
            .catch(function (err) {
                //console.log('Fetch Error :-S', err);
                PrintCovidVaccineStats(err, 1);
            });

        function PrintCovidVaccineStats(stats, err) {
            if (err !== 0) {
                document.getElementById("first-dose-total").innerHTML = "?";
                document.getElementById("second-dose-total").innerHTML = "?";
                document.getElementById("vaccine-dose-total").innerHTML = "?";
            }
            else {
                document.getElementById("first-dose-total").innerHTML = stats.TotalFirstDose.toLocaleString();
                document.getElementById("second-dose-total").innerHTML = stats.SecondDoseTotal.toLocaleString();
                document.getElementById("vaccine-dose-total").innerHTML = (stats.SecondDoseTotal + stats.TotalFirstDose).toLocaleString();

                //start render vaccine chart
                let vaccine_chart_labels = [];
                let vaccine_chart_values_fd = [];
                let vaccine_chart_values_sd = [];
                for (let i = 0; i < stats.TotalByType.length; i++) {
                    vaccine_chart_labels.push(stats.TotalByType[i].type);
                    vaccine_chart_values_fd.push(stats.TotalByType[i].firstDose);
                    vaccine_chart_values_sd.push(stats.TotalByType[i].secondDose);
                }

                //https://www.chartjs.org/docs/
                var ctx = document.getElementById('myChart').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: vaccine_chart_labels,
                        datasets: [{
                            label: 'First Dose',
                            data: vaccine_chart_values_fd,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }, {
                            label: 'Second Dose',
                            data: vaccine_chart_values_sd,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }

                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        //https://stackoverflow.com/questions/45182635/how-to-use-two-datasets-in-chart-js-doughnut-chart
                        //get the tooltip to show the datasetname:item:value
                        tooltips: {
                            callbacks: {
                                label: function (item, data) {
                                    console.log(data.labels, item);
                                    return data.datasets[item.datasetIndex].label + ": " + data.labels[item.index] + ": " + data.datasets[item.datasetIndex].data[item.index];
                                }
                            }
                        }
                    }
                });
                //end chart
            }
        }
    </script>


    <script>
        //render main map
        let map1;
        let mapView;
        let url = "";
        let featureLayer = "";
        require(["esri/Map", "esri/layers/FeatureLayer", "esri/views/MapView", "esri/widgets/Legend", "esri/request", "esri/widgets/Home"],
            function (Map, FeatureLayer, MapView, Legend, esriRequest, Home) {

                map1 = new Map({ basemap: "dark-gray-vector" }); //https://developers.arcgis.com/javascript/latest/api-reference/esri-Map.html#basemap

                let viewOptions = {
                    container: "mapview", map: map1,
                    center: [-7.912130968565811, 53.096755475713266], // Birr
                    zoom: 7 //calling mapview.fullextent (below) overwrites the zoom but calling the Home function from mapview will read the zoom level set here.

                }

                //render map
                mapView = new MapView(viewOptions);


                //create home button
                let homeBtn = new Home({
                    view: mapView
                });

                // Add the home button to the top left corner of the view
                mapView.ui.add(homeBtn, "top-left");

                //render legend
                let legend = new Legend({ view: mapView }, "legendview");
                // mapView.ui.add(legend, "top-right"); legend is rendered outside map in the legendview

                //todo format the evendate
                let templatetitle = "{ENGLISH}: 14 Day Incidence of confirmed COVID - 19 cases by LEA <br> data last updated : {EventDate} <hr>";

                let templatecontent = "<h4>LEA:";
                templatecontent = templatecontent + "{ENGLISH}</h4>";
                templatecontent = templatecontent + "<span style='color: red;'>COVID-19 - 14 Day Profile</span>";
                //todo:add the font family inline.
                //templatecontent = templatecontent + "<span style='color: red; font-family: " + "'Prompt'," + "'" + "sans-serif" + "'" + "'>COVID-19 - 14 Day Profile</span>";
                templatecontent = templatecontent + "<br>";
                templatecontent = templatecontent + "Confirmed Cases in LEA: {C19_P14_T}<br>";
                templatecontent = templatecontent + "LEA rate per 100k pop: {P14_100k}<br>";
                templatecontent = templatecontent + "R.of Ireland rate per 100k: {Ire_IncP14}<br><br>";
                templatecontent = templatecontent + "Total Population of {ENGLISH} : {Pop2016}";

                let template = {
                    // autocasts as new PopupTemplate()
                    title: templatetitle,
                    content: templatecontent,
                };

                featureLayer = new FeatureLayer({
                    url: "https://services-eu1.arcgis.com/z6bHNio59iTqqSUY/arcgis/rest/services/COVID19_14_Day_Incidence_Rate_per_100k_LEA/FeatureServer/0?f=pjson",
                    outFields: ["*"],
                    popupTemplate: template
                });

                map1.add(featureLayer);

                //set scale such that all data points are visible
                featureLayer.when(function () {
                    mapView.goTo(featureLayer.fullExtent);
                })
            });
    </script>
   
    <!--<audio autoplay loop>
        <source src="assets/audio/audio.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>-->
</body>
</html>
