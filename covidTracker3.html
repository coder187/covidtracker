<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covid Tracker</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.19/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.19/"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">

    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/main.js"></script>

</head>
<body>
    <audio autoplay loop>
        <source src="assets/audio/audio.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">COVID 19 Tracker</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
                <a class="nav-item nav-link active" href="#">Home <span class="sr-only">(current)</span></a>
                <a class="nav-item nav-link" href="#">Stay Up To Date</a>
                <a class="nav-item nav-link" href="#">Refresh</a>
                <a class="nav-item nav-link" href="#">Info on Data Sources</a>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col md-3 top-lvl-stats">
                <!--date last updated-->
                <div class="label">Last Update:</div>
                <span id="date-last-updated"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-3 top-lvl-stats">
                <!--total cases to date-->
                <div class="label">Total Cases:</div>
                <span id="Total"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-3 top-lvl-stats">
                <!--new deaths reported-->
                <div class="label">Deaths Last Reported:</div>
                <span id="Deaths"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-3 top-lvl-stats">
                <!--new cases reported-->
                <div class="label">Cases Last Reported:</div>
                <span id="Cases"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
        </div>
        <div class="row">
            <div class="col md-4 cases-by-county table-responsive">
                <!--total cases per county-->
                <ul id="county-list"></ul>
                <table id="county-list-table" class="">
                    <caption>Cases By County</caption>
                    <tr>
                        <th scope="col">County</th>
                        <th scope="col">Cases</th>
                        <th scope="col">Pop Perc</th>
                    </tr>
                    <tr>
                        <td colspan="3"><img src="assets/gif/loading.gif" alt="loading" /></td>
                    </tr>
                </table>
            </div>
            <div class="col md-4">
                <div class="row">
                    <div class="col">
                        <label for="maps">Choose a map:</label>
                        <select name="maps" id="select-maps">
                            <option value="LEA">14 Day Avg Per LEA</option>
                            <option value="saab">Cases Per County</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <!--lea 14 day moving avg MAP-->
                        <div id="mapview" style="width:750px;height:750px;" class="esri-widget"></div> <!-- placing style in file breaks popup-->
                    </div>
                </div>

            </div>
            <div class="col md-4">
                <!--MAP legend-->
                <div id="legendview"></div>
            </div>
        </div><!-- end row-->

        <div class="row">
            <div class="col md-4 vax-stats">
                <div class="label">First Dose Vaccines:</div>
                <span id="first-dose-total"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-4 vax-stats">
                <div class="label">Second Dose Vaccines:</div>
                <span id="second-dose-total"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-4 vax-stats">
                <div class="label">Total Vaccines:</div>
                <span id="vaccine-dose-total"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
        </div>
        <div class="row"><div class="col">Fancy Graph</div></div>
        <div class="row"><div class="col">Contact Form</div></div>
        <div class="row"><div class="col">Footer</div></div>

    </div> <!--end container-->
    <script>
        //Get Covid Stats:
        //Total Cases
        //New Cases
        //Deaths
        //Prev Day Cases
        //Prev Day Deaths

        GetCovidStats().then(
            function (message) {
                //console.log("Resolved: ", message);
                PrintCovidStats(message, 0);
            },
            function (error) {
                console.log("Rejected: ", error);
                PrintCovidStats(message, 1);
            }
        );

        function PrintCovidStats(stats, err) {
            if (err !== 0) {
                document.getElementById("date-last-updated").innerHTML = "?";
                document.getElementById("Deaths").innerHTML = "?";
                document.getElementById("Cases").innerHTML = "?";
                document.getElementById("Total").innerHTML = "?";
            }
            else {
                document.getElementById("date-last-updated").innerHTML = stats.DateLastUpdated.toDateString();
                document.getElementById("Deaths").innerHTML = stats.Deaths;
                document.getElementById("Cases").innerHTML = stats.Cases;
                document.getElementById("Total").innerHTML = stats.TotalCases.toLocaleString();

                //might comw back to this - to add perc inc/ dec
                //console.log(stats.CasesPrevDay);
                //console.log(PrecDiff(stats.CasesPrevDay, stats.Cases));

                //console.log(stats.DeathsPrevDay);
                //console.log(PrecDiff(stats.DeathsPrevDay, stats.Deaths));



            }
        }
        function PrecDiff(org, newval) {

            let diff = newval - org;
            diff = (diff / org) * 100;

            return diff;
        }
    </script>
    <script>
        GetCountyStats().then(
            function (message) {
                //console.log("Resolved: ", message);
                PrintCountyStats(message, 0);
            },
            function (error) {
                console.log("Print County Stats - Rejected: ", error);
                PrintCountyStats(message, 1);
            }
        );
        function PrintCountyStats(stats, err) {
            //let ul = document.getElementById("county-list");
            let tbl = document.getElementById("county-list-table");

            if (err !== 0) {
                //let li = document.createElement("li");
                //li.innerHTML = county[i] + "error ?";
                //ul.appendChild(li);

                let tr = document.createElement("tr");
                let td = document.createElement("td colspan=3");
                td.innerHTML = "error ?";
                tr.appendChild(td);
            }
            else {
                for (var i = 0; i < stats.length; i++) {

                    //let li = document.createElement("li");
                    //li.innerHTML = stats[i].County + "    " + stats[i].Confirmed + "    " + Math.round((stats[i].Confirmed / stats[i].PopulationC16) * 100 * 100)/100;//cases as percentage of County Population
                    //ul.appendChild(li);

                    let tr = document.createElement("tr");
                    let td = document.createElement("td");
                    td.innerHTML = stats[i].County;
                    tr.appendChild(td);

                    td = document.createElement("td");
                    td.innerHTML = stats[i].Confirmed;
                    tr.appendChild(td);

                    td = document.createElement("td");
                    td.innerHTML = Math.round((stats[i].Confirmed / stats[i].PopulationC16) * 100 * 100) / 100 + "%";
                    tr.appendChild(td);

                    tbl.appendChild(tr);
                }
            }
            tbl.deleteRow(1);//laoding gif
        }
    </script>

    <script>
        //render main map
        let map1;
        let mapView;
        let url = "";
        let featureLayer = "";
        require(["esri/Map", "esri/layers/FeatureLayer", "esri/views/MapView", "esri/widgets/Legend", "esri/request", "esri/widgets/Home"],
            function (Map, FeatureLayer, MapView, Legend, esriRequest, Home) {

                map1 = new Map({ basemap: "dark-gray-vector" }); //https://developers.arcgis.com/javascript/latest/api-reference/esri-Map.html#basemap


                let viewOptions = {
                    container: "mapview", map: map1,
                    center: [-7.912130968565811, 53.096755475713266], // Birr
                    zoom: 7
                }

                //render map
                mapView = new MapView(viewOptions);

                //create home button
                let homeBtn = new Home({
                    view: mapView
                });

                // Add the home button to the top left corner of the view
                mapView.ui.add(homeBtn, "top-left");

                //render legend
                let legend = new Legend({ view: mapView }, "legendview");
                // mapView.ui.add(legend, "top-right"); legend is rendered outside map in the legendview



                //todo format the evendate
                let templatetitle = "{ENGLISH}: 14 Day Incidence of confirmed COVID - 19 cases by LEA <br> data last updated : {EventDate} <hr>";

                let templatecontent = "<h4>LEA:";
                templatecontent = templatecontent + "{ENGLISH}</h4>";
                templatecontent = templatecontent + "<span style='color: red;'>COVID-19 - 14 Day Profile</span>";
                //todo:add the font family inline.
                //templatecontent = templatecontent + "<span style='color: red; font-family: " + "'Prompt'," + "'" + "sans-serif" + "'" + "'>COVID-19 - 14 Day Profile</span>";
                templatecontent = templatecontent + "<br>";
                templatecontent = templatecontent + "Confirmed Cases in LEA: {C19_P14_T}<br>";
                templatecontent = templatecontent + "LEA rate per 100k pop: {P14_100k}<br>";
                templatecontent = templatecontent + "R.of Ireland rate per 100k: {Ire_IncP14}<br><br>";
                templatecontent = templatecontent + "Total Population of {ENGLISH} : {Pop2016}";

                let template = {
                    // autocasts as new PopupTemplate()
                    title: templatetitle,
                    content: templatecontent,
                };

                featureLayer = new FeatureLayer({
                    url: "https://services-eu1.arcgis.com/z6bHNio59iTqqSUY/arcgis/rest/services/COVID19_14_Day_Incidence_Rate_per_100k_LEA/FeatureServer/0?f=pjson",
                    outFields: ["*"],
                    popupTemplate: template
                });

                map1.add(featureLayer);

                //set scale such that all data points are visible
                featureLayer.when(function () {
                    mapView.goTo(featureLayer.fullExtent);
                })
            });
    </script>

    <script>
        //GET VACCINE STATS
        //console.log("begin: vaccine stats");
        GetVaccineStats().then(
            function (message) {
                //console.log("Resolved: ", message);
                PrintCovidVaccineStats(message, 0);
            },
            function (error) {
                //console.log("GetVAccineStats - Rejected: ", error);
                PrintCovidVaccineStats(message, 1);
            }
        );
        //console.log("end: vaccine stats");

        function PrintCovidVaccineStats(stats, err) {
            if (err !== 0) {
                document.getElementById("first-dose-total").innerHTML = "?";
                document.getElementById("second-dose-total").innerHTML = "?";
                document.getElementById("vaccine-dose-total").innerHTML = "?";
            }
            else {
                document.getElementById("first-dose-total").innerHTML = stats.TotalFirstDose.toLocaleString();
                document.getElementById("second-dose-total").innerHTML = stats.SecondDoseTotal.toLocaleString();
                document.getElementById("vaccine-dose-total").innerHTML = (stats.SecondDoseTotal + stats.TotalFirstDose).toLocaleString();
            }
        }
    </script>
    <!--<script>
        //get the Event Date from the LEA data source and pass it to the map popup control.
        GetLEADateRange().then(
            function (message) {
                //console.log("GetLEADateRange Resolved: ", message);
                const LEA_DATE = new Date(message.EventDate); //use this in the map pop up.
            },
            function (error) {
                console.log("GetLEADateRange Rejected: ", error);
            }
        );
    </script>-->
</body>
</html>