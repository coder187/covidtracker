<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Covid Tracker</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.19/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.19/"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">

    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/main.js"></script>

</head>
<body>
    <audio autoplay loop>
        <source src="assets/audio/audio.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <div class="pagetitle">COVID 19 Tracker</div>
            </div>
        </div>
        <div class="row">
            <div class="col md-3 top-lvl-stats">
                <!--date last updated-->
                <div class="label">Last Update:</div>
                <span id="date-last-updated"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-3 top-lvl-stats">
                <!--total cases to date-->
                <div class="label">Total Cases:</div>
                <span id="Total"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-3 top-lvl-stats">
                <!--new deaths reported-->
                <div class="label">Deaths Last Reported:</div>
                 <span id="Deaths"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>
            <div class="col md-3 top-lvl-stats">
                <!--new cases reported-->
                <div class="label">Cases Last Reported:</div>
                <span id="Cases"><img src="assets/gif/loading.gif" alt="loading" /></span>
            </div>

        </div>
        <div class="row"><!--cases-by-county-->
            <div class="col md-4 cases-by-county">
                <!--total cases per county-->
                Cases By County<br />
                <ul id="county-list"></ul>
            </div>
            <div class="col md-4">
                <!--lea 14 day moving avg MAP-->
                <div id="mapview" style="width:750px;height:750px;"></div> <!-- placing style in file breaks popup-->
            </div>
            <div class="col md-4">
                <!--MAP legend-->
                <div id="legendview"></div>
            </div>
        </div><!-- end row-->
    </div> <!--end container-->
    <script>
        //Get Covid Stats:
        //Total Cases
        //New Cases
        //Deaths
        //Prev Day Cases
        //Prev Day Deaths

        GetCovidStats().then(
            function (message) {
                //console.log("Resolved: ", message);
                PrintCovidStats(message, 0);
            },
            function (error) {
                console.log("Rejected: ", error);
                PrintCovidStats(message, 1);
            }
        );

        function PrintCovidStats(stats, err) {
            if (err !== 0) {
                document.getElementById("date-last-updated").innerHTML = "?";
                document.getElementById("Deaths").innerHTML = "?";
                document.getElementById("Cases").innerHTML = "?";
                document.getElementById("Total").innerHTML = "?";
            }
            else {
                document.getElementById("date-last-updated").innerHTML = stats.DateLastUpdated.toDateString()   ;
                document.getElementById("Deaths").innerHTML = stats.Deaths;
                document.getElementById("Cases").innerHTML = stats.Cases;
                document.getElementById("Total").innerHTML = stats.TotalCases.toLocaleString();

                //might comw back to this - to add perc inc/ dec
                //console.log(stats.CasesPrevDay);
                //console.log(PrecDiff(stats.CasesPrevDay, stats.Cases));

                //console.log(stats.DeathsPrevDay);
                //console.log(PrecDiff(stats.DeathsPrevDay, stats.Deaths));

            }
        }
        function PrecDiff(org, newval) {

            let diff = newval - org;
            diff = (diff / org) * 100;

            return diff;
        }
    </script>
    <script>
        GetCountyStats().then(
            function (message) {
                //console.log("Resolved: ", message);
                PrintCountyStats( message, 0);
            },
            function (error) {
                console.log("Print County Stats - Rejected: ", error);
                PrintCountyStats(message, 1);
            }
        );
        function PrintCountyStats(stats, err) {
            let ul = document.getElementById("county-list");
            
            if (err !== 0) {
                let li = document.createElement("li");
                li.innerHTML = county[i] + "error ?";
                ul.appendChild(li);
            }
            else {
                for (var i = 0; i < stats.length; i++) {
                    let li = document.createElement("li");
                    li.innerHTML = stats[i].County + "    " + stats[i].Confirmed;
                    ul.appendChild(li);

                    //console.log(stats[i].ConfirmedRecovered);
                }
            }
        }
    </script>

    <script>
        //GetCountyStats()
    </script>

    <script>
        //render main map
        let map1;
        let mapView;
        let url = "";
        let featureLayer = "";
        require(["esri/Map", "esri/layers/FeatureLayer", "esri/views/MapView", "esri/widgets/Legend", "esri/request"],
            function (Map, FeatureLayer, MapView, Legend, esriRequest) {

                map1 = new Map({ basemap: "streets" });

                let viewOptions = {
                    container: "mapview", map: map1,
                    center: [-7.912130968565811, 53.096755475713266], // Birr
                    zoom: 7
                }

                //render map
                mapView = new MapView(viewOptions);

                //render legend
                let legend = new Legend({ view: mapView }, "legendview");
                // mapView.ui.add(legend, "top-right"); legend is rendered outside map in the legendview


                let templatetitle = "Adare-rathkeale LEA-6: 14 Day Incidence of confirmed COVID-19 cases by LEA"

                let templatecontent = "<p><h3>LEA:</h3>";
                templatecontent = templatecontent + "{ENGLISH}</p>";

                templatecontent = templatecontent + "<p>COVID-19 - 14 Day Profile<br>";
                templatecontent = templatecontent + "----<br>";
                templatecontent = templatecontent + "<br>";
                templatecontent = templatecontent + "Confirmed Cases in LEA: {C19_P14_T}<br>";
                templatecontent = templatecontent + "LEA rate per 100k pop: {P14_100k}<br>";
                templatecontent = templatecontent + "R.of Ireland rate per 100k: {Ire_IncP14}</p>";

                templatecontent = templatecontent + "<p>Total Population of {ENGLISH} : {Pop2016}</p>";


                let template = {
                    // autocasts as new PopupTemplate()
                    title: templatetitle,
                    content: templatecontent,
                };

                featureLayer = new FeatureLayer({
                    url: "https://services-eu1.arcgis.com/z6bHNio59iTqqSUY/arcgis/rest/services/COVID19_14_Day_Incidence_Rate_per_100k_LEA/FeatureServer/0?f=pjson",
                    outFields: ["*"],
                    popupTemplate: template
                });

                map1.add(featureLayer);

                //set scale such that all data points are visible
                featureLayer.when(function () {
                    mapView.goTo(featureLayer.fullExtent);
                })
            });
    </script>
</body>
</html>